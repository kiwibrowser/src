W3C Web Platform Tests in Blink Layout Tests

Design Doc: https://goo.gl/iXUaZd

This directory contains checked out and reduced code from web-platform-tests
(https://github.com/w3c/web-platform-tests/) required to run WPT tests as part
of Blink's test infrastructure and some maintenance/configuration code.

The third party code lives entirely in the wpt subdirectory:
tools/blinkpy/third_party/wpt/wpt

For licensing, see README.chromium in parent directory
(tools/blinkpy/third_party/README.chromium).

**

Files in this directory (non third-party)

README.chromium
===============
This file.

wpt.config.json
===============
The configuration file used when running WPTServe. Note that this file loads
after wpt/config.default.json and this configuration gets merged onto it. When
changing the ports (HTTP/S, WS/S), make sure to also:

- update `_get_http_host_and_ports_for_test` in
  `//third_party/blink/tools/blinkpy/web_tests/port/driver.py`
- update bot configs (e.g. `Site Isolation Linux` bot forces OOPIFs by using
  `--isolate-origins=http://www.web-platform.test:8001/` as specified in
  `//testing/buildbot/chromium.fyi.json`).

checkout.sh
===========
Running this script without arguments will remove the existing checkout
(third_party/wpt/wpt) and perform a fresh one. See "Rolling in WPT" for more.

WPTWhiteList
============
The explicit list of files being kept, everything else not on this list is
deleted when running "./checkout.sh reduce". Use this file to control what gets
checked in and try to keep the list as small as possible (use what you need).

certs/
======
This directory contains a private key and a certificate of WPTServe, and files
for self-signed CA. By default, WPTServe generates these files using the
"openssl" command, but we check in pre-generated files to avoid "openssl"
dependency.

These certificates will expire in January 2025. Here is an instruction to
re-generate them:

1. Add "openssl" command to PATH.
2. Apply the following change locally:

diff --git a/third_party/blink/tools/blinkpy/third_party/wpt/wpt.config.json b/third_party/blink/tools/blinkpy/third_party/wpt/wpt.config.json
index 6243954..84fd3f4 100644
--- a/third_party/blink/tools/blinkpy/third_party/wpt/wpt.config.json
+++ b/third_party/blink/tools/blinkpy/third_party/wpt/wpt.config.json
@@ -9,13 +9,5 @@
     "https": [8444],
     "ws": [9001],
     "wss": [9444]
-  },
-  "ssl": {
-    "type": "pregenerated",
-    "encrypt_after_connect": false,
-    "pregenerated": {
-      "host_key_path": "../certs/127.0.0.1.key",
-      "host_cert_path": "../certs/127.0.0.1.pem"
-    }
   }
 }
diff --git a/third_party/blink/tools/blinkpy/third_party/wpt/wpt/tools/sslutils/openssl.py b/third_party/blink/tools/blinkpy/third_party/wpt/wpt/tools/sslutils/openssl.py
index 5b571c0..223a18b 100644
--- a/third_party/blink/tools/blinkpy/third_party/wpt/wpt/tools/sslutils/openssl.py
+++ b/third_party/blink/tools/blinkpy/third_party/wpt/wpt/tools/sslutils/openssl.py
@@ -207,7 +207,7 @@ class OpenSSLEnvironment(object):

     def __init__(self, logger, openssl_binary="openssl", base_path=None,
                  password="web-platform-tests", force_regenerate=False,
-                 duration=30, base_conf_path=None):
+                 duration=3000, base_conf_path=None):
         """SSL environment that creates a local CA and host certificate using OpenSSL.

         By default this will look in base_path for existing certificates that are still

3. Run third_party/blink/tools/run_blink_wptserve.py
4. Type Enter key to terminate it.
5. Revert the local change.  e.g. git reset --hard HEAD
6. Replace certs/ with wpt/_certs/
   % rm -fr certs
   % mv wpt/_certs certs
7. Look at *.pem, and update "January 2025" in this document and expiration_date
   in wptserve.py to new expiration date.
8. git commit -a
9. git cl upload, etc.

TODO(tkent): Make a script to re-generate keys and certificates.

**

Rolling in WPT

When rolling in new versions of WPT support, modify WPT_HEAD in checkout.sh to
the desired HEAD position. You can then call "./checkout.sh clone" which will
pull in all the code.

It is also important to update the hashes in the 'Version:' fields of
tools/blinkpy/third_party/README.chromium.

You can examine what's pulled in and update WPTWhiteList if some new files are
required to run the updated version.

Once you've cloned the repositories you can call "./checkout.sh reduce" to
remove everything that is not listed in WPTWhiteList.

Note that calling "./checkout.sh" without arguments is equivalent of calling
"./checkout.sh clone reduce".

**

Configuration

Read instructions in WPT README:
https://github.com/w3c/web-platform-tests/blob/master/README.md

Also, check out the WPTServe Documentation
(https://wptserve.readthedocs.org/en/latest/).

Note that editing /etc/hosts is not required for run_web_tests.py since
content_shell is invoked with flags to map all *.test domains to 127.0.0.1.

**

Running web-platform-tests with enabled WPTServe on a local machine

WPTServe is now enabled by default in run_web_tests.py for tests that live in
LayoutTests/external/wpt.

WPTServe starts HTTP/S and WS/S servers as separate processes.

The content_shell used to run the tests will receive the URL of each test
(instead of a filename). The document root http://web-platform.test/ maps to
LayoutTests/external/wpt. HTTPS tests are enabled by default.

Example run:

./tools/run_web_tests.py external/wpt
